<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OpenFOAM中的DSMC求解器dsmcFoam分析 | Lianhua Zhu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="dsmcFoam solver分析dsmcFoam 的架构：
主要的源文件：

dsmcFoam.C
DsmcCloud.C
DsmcCloud.H
dsmcFields function object

dsmcFoma 源码：12345678910111213141516171819202122232425262728293031int main(int argc, char *argv[])">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenFOAM中的DSMC求解器dsmcFoam分析">
<meta property="og:url" content="http://yoursite.com/2016/10/07/of-dsmcFoam/index.html">
<meta property="og:site_name" content="Lianhua Zhu's Blog">
<meta property="og:description" content="dsmcFoam solver分析dsmcFoam 的架构：
主要的源文件：

dsmcFoam.C
DsmcCloud.C
DsmcCloud.H
dsmcFields function object

dsmcFoma 源码：12345678910111213141516171819202122232425262728293031int main(int argc, char *argv[])">
<meta property="og:updated_time" content="2016-10-07T07:49:45.775Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenFOAM中的DSMC求解器dsmcFoam分析">
<meta name="twitter:description" content="dsmcFoam solver分析dsmcFoam 的架构：
主要的源文件：

dsmcFoam.C
DsmcCloud.C
DsmcCloud.H
dsmcFields function object

dsmcFoma 源码：12345678910111213141516171819202122232425262728293031int main(int argc, char *argv[])">
  
    <link rel="alternate" href="/atom.xml" title="Lianhua Zhu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Lianhua Zhu&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-of-dsmcFoam" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/07/of-dsmcFoam/" class="article-date">
  <time datetime="2016-10-07T07:33:29.000Z" itemprop="datePublished">2016-10-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OpenFOAM中的DSMC求解器dsmcFoam分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="dsmcFoam-solver分析"><a href="#dsmcFoam-solver分析" class="headerlink" title="dsmcFoam solver分析"></a>dsmcFoam solver分析</h3><p>dsmcFoam 的架构：</p>
<p>主要的源文件：</p>
<ul>
<li><a href="https://github.com/OpenFOAM/OpenFOAM-2.3.x/blob/master/applications/solvers/discreteMethods/dsmc/dsmcFoam/dsmcFoam.C" target="_blank" rel="external"><code>dsmcFoam.C</code></a></li>
<li><a href="https://github.com/OpenFOAM/OpenFOAM-2.3.x/blob/master/src/lagrangian/dsmc/clouds/Templates/DsmcCloud/DsmcCloud.C" target="_blank" rel="external"><code>DsmcCloud.C</code></a></li>
<li><a href="https://github.com/OpenFOAM/OpenFOAM-2.3.x/blob/master/src/lagrangian/dsmc/clouds/Templates/DsmcCloud/DsmcCloud.H" target="_blank" rel="external"><code>DsmcCloud.H</code></a></li>
<li><a href="https://github.com/OpenFOAM/OpenFOAM-2.3.x/tree/master/src/postProcessing/functionObjects/utilities/dsmcFields" target="_blank" rel="external"><code>dsmcFields</code> function object</a></li>
</ul>
<h4 id="dsmcFoma-源码："><a href="#dsmcFoma-源码：" class="headerlink" title="dsmcFoma 源码："></a><code>dsmcFoma</code> 源码：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"setRootCase.H"</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"createTime.H"</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"createMesh.H"</span></span></div><div class="line"></div><div class="line">    <span class="comment">// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //</span></div><div class="line"></div><div class="line">    Info&lt;&lt; nl &lt;&lt; <span class="string">"Constructing dsmcCloud "</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="function">dsmcCloud <span class="title">dsmc</span><span class="params">(<span class="string">"dsmc"</span>, mesh)</span></span>;</div><div class="line"></div><div class="line">    Info&lt;&lt; <span class="string">"\nStarting time loop\n"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (runTime.loop())</div><div class="line">    &#123;</div><div class="line">        Info&lt;&lt; <span class="string">"Time = "</span> &lt;&lt; runTime.timeName() &lt;&lt; nl &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">        dsmc.evolve(); <span class="comment">//&lt;&lt;------ 这里是演化步</span></div><div class="line">        dsmc.info();  <span class="comment">//&lt;&lt;------ dump到屏幕一些基本信息</span></div><div class="line">        runTime.write(); <span class="comment">//&lt;&lt;------- 这里很关键，到底写的是什么</span></div><div class="line"></div><div class="line">        Info&lt;&lt; nl &lt;&lt; <span class="string">"ExecutionTime = "</span> &lt;&lt; runTime.elapsedCpuTime() &lt;&lt; <span class="string">" s"</span></div><div class="line">            &lt;&lt; <span class="string">"  ClockTime = "</span> &lt;&lt; runTime.elapsedClockTime() &lt;&lt; <span class="string">" s"</span></div><div class="line">            &lt;&lt; nl &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Info&lt;&lt; <span class="string">"End\n"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="DsmcCloud-关键函数分析"><a href="#DsmcCloud-关键函数分析" class="headerlink" title="DsmcCloud 关键函数分析"></a>DsmcCloud 关键函数分析</h4><p><code>DsmcCloud::evolve()</code> 主要演化过程在这里</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ParcelType&gt;</div><div class="line"><span class="keyword">void</span> Foam::DsmcCloud&lt;ParcelType&gt;::evolve()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">typename</span> ParcelType::<span class="function">trackingData <span class="title">td</span><span class="params">(*<span class="keyword">this</span>)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// Reset the data collection fields</span></div><div class="line">    resetFields();  <span class="comment">//&lt;&lt;------ 每个演化步都需要重置 rhoN_ rhoM_ linearKE_ ... 等等这些场为0；</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (debug)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>-&gt;dumpParticlePositions();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Insert new particles from the inflow boundary</span></div><div class="line">    <span class="keyword">this</span>-&gt;inflowBoundary().inflow();  <span class="comment">//&lt;&lt;------ 处理边界</span></div><div class="line"></div><div class="line">    <span class="comment">// Move the particles ballistically with their current velocities</span></div><div class="line">    Cloud&lt;ParcelType&gt;::move(td, mesh_.time().deltaTValue()); <span class="comment">//&lt;&lt;------ 自由迁移，得到particle新的位置</span></div><div class="line"></div><div class="line">    <span class="comment">// Update cell occupancy</span></div><div class="line">    buildCellOccupancy(); <span class="comment">//&lt;&lt;-------</span></div><div class="line"></div><div class="line">    <span class="comment">// Calculate new velocities via stochastic collisions</span></div><div class="line">    collisions(); <span class="comment">//&lt;&lt;------ 碰撞处理，得到particle新的速度</span></div><div class="line"></div><div class="line">    <span class="comment">// Calculate the volume field data</span></div><div class="line">    calculateFields(); <span class="comment">//&lt;&lt;------每个演化步都需要统计 rhoN_ rhoM_ linearKE_ ... 等等这些场为；</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DsmcCloud::resetFields()</code> 每个演化步都需要重置这些场为0，为开始统计做准备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ParcelType&gt;</div><div class="line"><span class="keyword">void</span> Foam::DsmcCloud&lt;ParcelType&gt;::resetFields()</div><div class="line">&#123;</div><div class="line">    q_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">1</span>, <span class="number">0</span>, <span class="number">-3</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">0.0</span>);</div><div class="line"></div><div class="line">    fD_ = dimensionedVector</div><div class="line">    (</div><div class="line">        <span class="string">"zero"</span>,</div><div class="line">        dimensionSet(<span class="number">1</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">0</span>),</div><div class="line">        <span class="built_in">vector</span>::zero</div><div class="line">    );</div><div class="line"></div><div class="line">    rhoN_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">0</span>, <span class="number">-3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), VSMALL);</div><div class="line">    rhoM_ =  dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">1</span>, <span class="number">-3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), VSMALL);</div><div class="line">    dsmcRhoN_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">0</span>, <span class="number">-3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">0.0</span>);</div><div class="line">    linearKE_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">1</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">0.0</span>);</div><div class="line">    internalE_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">1</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">0.0</span>);</div><div class="line">    iDof_ = dimensionedScalar(<span class="string">"zero"</span>,  dimensionSet(<span class="number">0</span>, <span class="number">-3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), VSMALL);</div><div class="line">    momentum_ = dimensionedVector</div><div class="line">    (</div><div class="line">        <span class="string">"zero"</span>,</div><div class="line">        dimensionSet(<span class="number">1</span>, <span class="number">-2</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>),</div><div class="line">        <span class="built_in">vector</span>::zero</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DsmcCloud::calculateFields()</code>: 统计场</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ParcelType&gt;</div><div class="line"><span class="keyword">void</span> Foam::DsmcCloud&lt;ParcelType&gt;::calculateFields()</div><div class="line">&#123;</div><div class="line">    scalarField&amp; rhoN = rhoN_.internalField();</div><div class="line">    scalarField&amp; rhoM = rhoM_.internalField();</div><div class="line">    scalarField&amp; dsmcRhoN = dsmcRhoN_.internalField();</div><div class="line">    scalarField&amp; linearKE = linearKE_.internalField();</div><div class="line">    scalarField&amp; internalE = internalE_.internalField();</div><div class="line">    scalarField&amp; iDof = iDof_.internalField();</div><div class="line">    vectorField&amp; momentum = momentum_.internalField();</div><div class="line"></div><div class="line">    forAllConstIter(<span class="keyword">typename</span> DsmcCloud&lt;ParcelType&gt;, *<span class="keyword">this</span>, iter)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">const</span> ParcelType&amp; p = iter();</div><div class="line">        <span class="keyword">const</span> label cellI = p.cell();</div><div class="line">        rhoN[cellI]++;</div><div class="line">        rhoM[cellI] += constProps(p.typeId()).mass();</div><div class="line">        dsmcRhoN[cellI]++;</div><div class="line">        linearKE[cellI] += <span class="number">0.5</span>*constProps(p.typeId()).mass()*(p.U() &amp; p.U());</div><div class="line">        internalE[cellI] += p.Ei();</div><div class="line">        iDof[cellI] += constProps(p.typeId()).internalDegreesOfFreedom();</div><div class="line">        momentum[cellI] += constProps(p.typeId()).mass()*p.U();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    rhoN *= nParticle_/mesh().cellVolumes();</div><div class="line">    rhoN_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    rhoM *= nParticle_/mesh().cellVolumes();</div><div class="line">    rhoM_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    dsmcRhoN_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    linearKE *= nParticle_/mesh().cellVolumes();</div><div class="line">    linearKE_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    internalE *= nParticle_/mesh().cellVolumes();</div><div class="line">    internalE_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    iDof *= nParticle_/mesh().cellVolumes();</div><div class="line">    iDof_.correctBoundaryConditions();</div><div class="line"></div><div class="line">    momentum *= nParticle_/mesh().cellVolumes();</div><div class="line">    momentum_.correctBoundaryConditions();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看看<code>DsmcCloud</code>的构造函数，可以发现它主要存储哪些东西：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// * * * * * * * * * * * * * * * * Constructors  * * * * * * * * * * * * * * //</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ParcelType&gt;</div><div class="line">Foam::DsmcCloud&lt;ParcelType&gt;::DsmcCloud</div><div class="line">(</div><div class="line">    <span class="keyword">const</span> word&amp; cloudName,</div><div class="line">    <span class="keyword">const</span> fvMesh&amp; mesh,</div><div class="line">    <span class="keyword">bool</span> readFields</div><div class="line">)</div><div class="line">:</div><div class="line">    Cloud&lt;ParcelType&gt;(mesh, cloudName, <span class="literal">false</span>),</div><div class="line">    DsmcBaseCloud(),</div><div class="line">    cloudName_(cloudName),</div><div class="line">    mesh_(mesh),</div><div class="line">    particleProperties_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            cloudName + <span class="string">"Properties"</span>,</div><div class="line">            mesh_.time().constant(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ_IF_MODIFIED,</div><div class="line">            IOobject::NO_WRITE</div><div class="line">        )</div><div class="line">    ),</div><div class="line">    typeIdList_(particleProperties_.lookup(<span class="string">"typeIdList"</span>)),</div><div class="line">    nParticle_(readScalar(particleProperties_.lookup(<span class="string">"nEquivalentParticles"</span>))),</div><div class="line">    cellOccupancy_(mesh_.nCells()),</div><div class="line">    sigmaTcRMax_ <span class="comment">//&lt;&lt;------ 这个主要是作为计算的时候用，输出并没有意义。</span></div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="keyword">this</span>-&gt;name() + <span class="string">"SigmaTcRMax"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,  <span class="comment">//&lt;&lt;------ 这里都是MUST_READ</span></div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    collisionSelectionRemainder_(mesh_.nCells(), <span class="number">0</span>),</div><div class="line">    q_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"q"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    fD_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"fD"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    rhoN_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"rhoN"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    rhoM_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"rhoM"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    dsmcRhoN_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"dsmcRhoN"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    linearKE_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"linearKE"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    internalE_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"internalE"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    iDof_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"iDof"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    momentum_</div><div class="line">    (</div><div class="line">        IOobject</div><div class="line">        (</div><div class="line">            <span class="string">"momentum"</span>,</div><div class="line">            mesh_.time().timeName(),</div><div class="line">            mesh_,</div><div class="line">            IOobject::MUST_READ,</div><div class="line">            IOobject::AUTO_WRITE</div><div class="line">        ),</div><div class="line">        mesh_</div><div class="line">    ),</div><div class="line">    constProps_(),</div><div class="line">    rndGen_(label(<span class="number">149382906</span>) + <span class="number">7183</span>*Pstream::myProcNo()),</div><div class="line">    boundaryT_</div><div class="line">    (</div><div class="line">        volScalarField</div><div class="line">        (</div><div class="line">            IOobject</div><div class="line">            (</div><div class="line">                <span class="string">"boundaryT"</span>,</div><div class="line">                mesh_.time().timeName(),</div><div class="line">                mesh_,</div><div class="line">                IOobject::MUST_READ,</div><div class="line">                IOobject::AUTO_WRITE</div><div class="line">            ),</div><div class="line">            mesh_</div><div class="line">        )</div><div class="line">    ),</div><div class="line">    boundaryU_</div><div class="line">    (</div><div class="line">        volVectorField</div><div class="line">        (</div><div class="line">            IOobject</div><div class="line">            (</div><div class="line">                <span class="string">"boundaryU"</span>,</div><div class="line">                mesh_.time().timeName(),</div><div class="line">                mesh_,</div><div class="line">                IOobject::MUST_READ,</div><div class="line">                IOobject::AUTO_WRITE</div><div class="line">            ),</div><div class="line">            mesh_</div><div class="line">        )</div><div class="line">    ),</div><div class="line">    binaryCollisionModel_</div><div class="line">    (</div><div class="line">        BinaryCollisionModel&lt;DsmcCloud&lt;ParcelType&gt; &gt;::New</div><div class="line">        (</div><div class="line">            particleProperties_,</div><div class="line">            *<span class="keyword">this</span></div><div class="line">        )</div><div class="line">    ),</div><div class="line">    wallInteractionModel_</div><div class="line">    (</div><div class="line">        WallInteractionModel&lt;DsmcCloud&lt;ParcelType&gt; &gt;::New</div><div class="line">        (</div><div class="line">            particleProperties_,</div><div class="line">            *<span class="keyword">this</span></div><div class="line">        )</div><div class="line">    ),</div><div class="line">    inflowBoundaryModel_</div><div class="line">    (</div><div class="line">        InflowBoundaryModel&lt;DsmcCloud&lt;ParcelType&gt; &gt;::New</div><div class="line">        (</div><div class="line">            particleProperties_,</div><div class="line">            *<span class="keyword">this</span></div><div class="line">        )</div><div class="line">    )</div><div class="line">&#123;</div><div class="line">    buildConstProps();</div><div class="line"></div><div class="line">    buildCellOccupancy();</div><div class="line"></div><div class="line">    <span class="comment">// Initialise the collision selection remainder to a random value between 0</span></div><div class="line">    <span class="comment">// and 1.</span></div><div class="line">    forAll(collisionSelectionRemainder_, i)</div><div class="line">    &#123;</div><div class="line">        collisionSelectionRemainder_[i] = rndGen_.scalar01();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (readFields)</div><div class="line">    &#123;</div><div class="line">        ParcelType::readFields(*<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现<code>DsmcCloud</code>的演化过程十分清晰明了。就是内部记录了一些extensive fields，和 particle的位置、速度。然后每个演化步统计这些 extensive fields，然后执行迁移和碰撞，边界处理。这些extensive fields完全由新时刻的particle速度计算出来。</p>
<h4 id="fieldAverage-分析"><a href="#fieldAverage-分析" class="headerlink" title="fieldAverage 分析"></a>fieldAverage 分析</h4><p>在一个dsmcFoam的case里面，<code>controlDict</code> 文件里面要设置在求解过程中输出一些时间平均的场, 这由OpenFOAM本身提供的<code>fieldAverage</code> 和dsmcFOAM提供的<code>dsmcField</code> 这两个<a href="http://cfd.direct/openfoam/user-guide/function-objects/" target="_blank" rel="external">Function object</a>来完成。</p>
<p><strong>NOTE</strong>: 关于<code>fieldAverage</code> Function object到底是怎样进行时间平均的， <a href="http://xiaopingqiu.github.io/2015/04/12/fieldAverage/" target="_blank" rel="external">这篇博文</a>有很好的分析。</p>
<p>下面这个例子是一个dsmcFoam case里<code>controlDict</code>文件的<code>functions</code>部分:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">functions <span class="comment">// 这里面是设置了两个时间平均计算，一个是fieldAverage1，另一个是dsmcFields1</span></div><div class="line">&#123;</div><div class="line">    fieldAverage1</div><div class="line">    &#123;</div><div class="line">        type            fieldAverage; <span class="comment">//&lt;&lt;------ 这个是OpenFOAM本身提供的。</span></div><div class="line">        functionObjectLibs ( <span class="string">"libfieldFunctionObjects.so"</span> );</div><div class="line">        outputControl   outputTime; <span class="comment">//&lt;&lt;------  随着每次dsmcFoam输出AUTO_WRITE属性的</span></div><div class="line">                                    <span class="comment">//场（由controlDict里面的writeControl控制）</span></div><div class="line">                                    <span class="comment">//的时候都会输出这些时均场。</span></div><div class="line">        resetOnOutput   <span class="literal">false</span>;</div><div class="line"></div><div class="line">        fields</div><div class="line">        (</div><div class="line">            rhoN</div><div class="line">            &#123;</div><div class="line">                mean        on;</div><div class="line">                prime2Mean  off;</div><div class="line">                base        time; <span class="comment">// 如果base设为time的话，每个演化步都会计算一次时均</span></div><div class="line">                <span class="comment">//windows    2;   //窗口长度为2，就是相对于没有windows,统计频率会降低一倍。</span></div><div class="line">            &#125;</div><div class="line">            rhoM</div><div class="line">            &#123;</div><div class="line">                mean        on;</div><div class="line">                prime2Mean  off;</div><div class="line">                base        time;</div><div class="line">            &#125;</div><div class="line">            ... <span class="comment">//省略</span></div><div class="line">            fD</div><div class="line">            &#123;</div><div class="line">                mean        on;</div><div class="line">                prime2Mean  off;</div><div class="line">                base        time;</div><div class="line">            &#125;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    dsmcFields1</div><div class="line">    &#123;</div><div class="line">        type            dsmcFields;</div><div class="line">        functionObjectLibs ( <span class="string">"libutilityFunctionObjects.so"</span> );</div><div class="line">        enabled         <span class="literal">true</span>;</div><div class="line">        outputControl   outputTime;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面设置每个需要计算时均值的场的设置。包括<code>mean</code>,<code>prome2Mean</code>,<code>base</code>,<code>window</code>。时均场输出的文件名后面会多一个<em>Mean</em>。 如momentum的时均场为momentumMean。</p>
<p>上面的设置中<code>base</code>为<code>time</code>，发现计算过程中每个演化步(<code>DsmcCloud::evolve()</code>)都计算了时均场，log里面每个演化都会出现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fieldAverage fieldAverage1 output:</div><div class="line">    Calculating averages</div></pre></td></tr></table></figure>
<ul>
<li>如果不设置<code>window</code> : 每次计算的时均场都是从<strong>求解开始到目前所有步</strong>的时均场。</li>
<li>如果设置了<code>window</code> :  <blockquote><p>base用来指定作时间平均的基础，是基于时间步数(ITER)还是物理时间(time);  window用来作平均的时间段的长度，如果不设定，则求的是从开始到当前时间这个时间段的平均值。window的数值的实际含义依base而定，如果base是ITER，则window=20表示当前步及其前 19 个时间步从 20 个时间步内的平均，而如果base是time,则表示的是 20s 内的平均。</p>
</blockquote>
</li>
</ul>
<p>在输出数据文件时（每evolve 100次）还会输出<code>fieldAverage1</code>设置的时均场(<code>writing average fields</code>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">fieldAverage fieldAverage1 output:</div><div class="line">    Calculating averages</div><div class="line">    writing average fields //&lt;------ 表示输出时均场</div><div class="line"></div><div class="line">Calculating dsmcFields.</div><div class="line">    Calculating UMean field.</div><div class="line">    Calculating translationalT field.</div><div class="line">    Calculating internalT field.</div><div class="line">    Calculating overallT field.</div><div class="line">    Calculating pressure field.</div><div class="line">    mag(UMean) max/min : 76.50092418551631 1.282028354585403</div><div class="line">    translationalT max/min : 436.5786449656766 219.0809500397843</div><div class="line">    internalT max/min : 0 0</div><div class="line">    overallT max/min : 436.5786449656766 219.0809500397843</div><div class="line">    p max/min : 67296.44015303567 42358.60866053814</div><div class="line">dsmcFields written.</div></pre></td></tr></table></figure>
<p><strong>NOTE</strong>: 可以发现在<code>writing average fields</code>的时候<code>dsmcFields</code> function object被触发了，它计算<code>UMean</code>,<code>translationalT</code>,<code>internalT</code>,<code>overallT</code>,<code>pressure</code>等场。</p>
<p>可以定义两个开关分别是<code>resetOnOutput</code>和<code>resetOnRestart</code>, 其意义是：</p>
<blockquote>
<p>resetOnRestart的值决定当solver继续运行时，是否要读取最近一个时间步的meanField的值来计算接下来时刻的时均值；&gt;resetOnOutput，顾名思义，是否要在每一次输出到文件以后重置meanField的值。这两个开关的默认值都是false。”</p>
</blockquote>
<p>这里可能有个疑问，如果不做这两个时均计算会怎样？会不会影响计算过程？毕竟dsmc的计算过程不依赖于这些宏观量场以及它们的时均场。这个疑问是很自然的。可以通过一个例子分析一下：<br>如果在<code>controlDict</code>文件里面如下设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">startTime       0;</div><div class="line">stopAt          endTime;</div><div class="line">endTime         1e-8;</div><div class="line">deltaT          1e-11;</div><div class="line">writeControl    timeStep;</div><div class="line">writeInterval   100;</div></pre></td></tr></table></figure>
<p>表示计算1000步，每100步输出。</p>
<ol>
<li>如果我们再注释掉<code>functions</code>部分, 也就是不求平均。运行dsmcFoam，也没有问题，不会报错。运行完会产生10个数据文件目录（1000/100=10）。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[lhzhu@ws3 dsmc1]$ ls</div><div class="line">0  1e-08  1e-09  2e-09  3e-09  4e-09  5e-09  6e-09  7e-09  8e-09  9e-09  constant  log  PyFoamHistory  system</div></pre></td></tr></table></figure>
<p>每个目录里面只有当前步的统计出来的场(非时均)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[lhzhu@ws3 dsmc1]$ ls 1e-09</div><div class="line">boundaryT  boundaryU  dsmcRhoN  dsmcSigmaTcRMax  fD  iDof  internalE  lagrangian  linearKE  momentum  q  rhoM  rhoN  uniform</div></pre></td></tr></table></figure>
<ol>
<li>但是如果我们如果只注释掉<code>functions</code>里面的<code>fieldAverage1</code>部分，或者只去掉 <code>fieldAverage1</code>里面的任何一个时均场，则会报错。比如去掉<code>fD</code>的时均计算，会有Fatal Error如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--&gt; FOAM FATAL ERROR:</div><div class="line">    request for volVectorField fDMean from objectRegistry region0 failed</div></pre></td></tr></table></figure>
<p>这个错误应该是在执行<code>dsmcFields</code> function object 时产生的。下面我们分析<code>dsmcFields</code>。</p>
<h4 id="dsmcFields分析"><a href="#dsmcFields分析" class="headerlink" title="dsmcFields分析"></a>dsmcFields分析</h4><p>源文件位置： <a href="https://github.com/OpenFOAM/OpenFOAM-2.3.x/tree/master/src/postProcessing/functionObjects/utilities/dsmcFields" target="_blank" rel="external">https://github.com/OpenFOAM/OpenFOAM-2.3.x/tree/master/src/postProcessing/functionObjects/utilities/dsmcFields</a></p>
<p><code>dsmcFields.H</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Description</div><div class="line">    Calculate intensive fields:</div><div class="line">    - UMean</div><div class="line">    - translationalT</div><div class="line">    - internalT</div><div class="line">    - overallT</div><div class="line">    from averaged extensive fields from a DSMC calculation.</div><div class="line">SourceFiles</div><div class="line">    dsmcFields.C</div><div class="line">    IOdsmcFields.H</div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> dsmcFields</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Private data</span></div><div class="line"></div><div class="line">        <span class="comment">//- Name of this set of dsmcFields objects</span></div><div class="line">        word name_;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> objectRegistry&amp; obr_;</div><div class="line"></div><div class="line">        <span class="comment">//- on/off switch</span></div><div class="line">        <span class="keyword">bool</span> active_;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Private Member Functions</span></div><div class="line"></div><div class="line">        <span class="comment">//- Disallow default bitwise copy construct</span></div><div class="line">        dsmcFields(<span class="keyword">const</span> dsmcFields&amp;);</div><div class="line"></div><div class="line">        <span class="comment">//- Disallow default bitwise assignment</span></div><div class="line">        <span class="keyword">void</span> <span class="keyword">operator</span>=(<span class="keyword">const</span> dsmcFields&amp;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line"></div><div class="line">    <span class="comment">//- Runtime type information</span></div><div class="line">    TypeName(<span class="string">"dsmcFields"</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Constructors</span></div><div class="line"></div><div class="line">        <span class="comment">//- Construct for given objectRegistry and dictionary.</span></div><div class="line">        <span class="comment">//  Allow the possibility to load fields from files</span></div><div class="line">        dsmcFields</div><div class="line">        (</div><div class="line">            <span class="keyword">const</span> word&amp; name,</div><div class="line">            <span class="keyword">const</span> objectRegistry&amp;,</div><div class="line">            <span class="keyword">const</span> dictionary&amp;,</div><div class="line">            <span class="keyword">const</span> <span class="keyword">bool</span> loadFromFiles = <span class="literal">false</span></div><div class="line">        );</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//- Destructor</span></div><div class="line">    <span class="keyword">virtual</span> ~dsmcFields();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Member Functions</span></div><div class="line"></div><div class="line">        <span class="comment">//- Return name of the set of dsmcFields</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> word&amp; <span class="title">name</span><span class="params">()</span> <span class="keyword">const</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> name_;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//- Read the dsmcFields data</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">const</span> dictionary&amp;)</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//- Execute, currently does nothing</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//- Execute at the final time-loop, currently does nothing</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//- Called when time was set at the end of the Time::operator++</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">timeSet</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">//- Calculate the dsmcFields and write</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>; <span class="comment">//&lt;------ 最重要的是这个函数</span></div><div class="line"></div><div class="line">        <span class="comment">//- Update for changes of mesh</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">updateMesh</span><span class="params">(<span class="keyword">const</span> mapPolyMesh&amp;)</span></span></div><div class="line">        &#123;&#125;</div><div class="line"></div><div class="line">        <span class="comment">//- Update for changes of mesh</span></div><div class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">movePoints</span><span class="params">(<span class="keyword">const</span> polyMesh&amp;)</span></span></div><div class="line">        &#123;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>dsmcFields::write()</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line">void Foam::dsmcFields::write()</div><div class="line">&#123;</div><div class="line">    if (active_)</div><div class="line">    &#123;</div><div class="line">        word rhoNMeanName = "rhoNMean";</div><div class="line">        word rhoMMeanName = "rhoMMean";</div><div class="line">        word momentumMeanName = "momentumMean";</div><div class="line">        word linearKEMeanName = "linearKEMean";</div><div class="line">        word internalEMeanName = "internalEMean";</div><div class="line">        word iDofMeanName = "iDofMean";</div><div class="line">        word fDMeanName = "fDMean";</div><div class="line"></div><div class="line">        const volScalarField&amp; rhoNMean = obr_.lookupObject&lt;volScalarField&gt;</div><div class="line">        (</div><div class="line">            rhoNMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volScalarField&amp; rhoMMean = obr_.lookupObject&lt;volScalarField&gt;</div><div class="line">        (</div><div class="line">            rhoMMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volVectorField&amp; momentumMean = obr_.lookupObject&lt;volVectorField&gt;</div><div class="line">        (</div><div class="line">            momentumMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volScalarField&amp; linearKEMean = obr_.lookupObject&lt;volScalarField&gt;</div><div class="line">        (</div><div class="line">            linearKEMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volScalarField&amp; internalEMean = obr_.lookupObject&lt;volScalarField&gt;</div><div class="line">        (</div><div class="line">            internalEMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volScalarField&amp; iDofMean = obr_.lookupObject&lt;volScalarField&gt;</div><div class="line">        (</div><div class="line">            iDofMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        const volVectorField&amp; fDMean = obr_.lookupObject&lt;volVectorField&gt;</div><div class="line">        (</div><div class="line">            fDMeanName</div><div class="line">        );</div><div class="line"></div><div class="line">        if (min(mag(rhoNMean)).value() &gt; VSMALL)</div><div class="line">        &#123;</div><div class="line">            Info&lt;&lt; "Calculating dsmcFields." &lt;&lt; endl;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    Calculating UMean field." &lt;&lt; endl;</div><div class="line">            volVectorField UMean</div><div class="line">            (</div><div class="line">                IOobject</div><div class="line">                (</div><div class="line">                    "UMean",</div><div class="line">                    obr_.time().timeName(),</div><div class="line">                    obr_,</div><div class="line">                    IOobject::NO_READ</div><div class="line">                ),</div><div class="line">                momentumMean/rhoMMean</div><div class="line">            );</div><div class="line"></div><div class="line">            Info&lt;&lt; "    Calculating translationalT field." &lt;&lt; endl;</div><div class="line">            volScalarField translationalT</div><div class="line">            (</div><div class="line">                IOobject</div><div class="line">                (</div><div class="line">                    "translationalT",</div><div class="line">                    obr_.time().timeName(),</div><div class="line">                    obr_,</div><div class="line">                    IOobject::NO_READ</div><div class="line">                ),</div><div class="line"></div><div class="line">                2.0/(3.0*physicoChemical::k.value()*rhoNMean)</div><div class="line">               *(linearKEMean - 0.5*rhoMMean*(UMean &amp; UMean))</div><div class="line">            );</div><div class="line"></div><div class="line">            Info&lt;&lt; "    Calculating internalT field." &lt;&lt; endl;</div><div class="line">            volScalarField internalT</div><div class="line">            (</div><div class="line">                IOobject</div><div class="line">                (</div><div class="line">                    "internalT",</div><div class="line">                    obr_.time().timeName(),</div><div class="line">                    obr_,</div><div class="line">                    IOobject::NO_READ</div><div class="line">                ),</div><div class="line">                (2.0/physicoChemical::k.value())*(internalEMean/iDofMean)</div><div class="line">            );</div><div class="line"></div><div class="line">            Info&lt;&lt; "    Calculating overallT field." &lt;&lt; endl;</div><div class="line">            volScalarField overallT</div><div class="line">            (</div><div class="line">                IOobject</div><div class="line">                (</div><div class="line">                    "overallT",</div><div class="line">                    obr_.time().timeName(),</div><div class="line">                    obr_,</div><div class="line">                    IOobject::NO_READ</div><div class="line">                ),</div><div class="line">                2.0/(physicoChemical::k.value()*(3.0*rhoNMean + iDofMean))</div><div class="line">               *(linearKEMean - 0.5*rhoMMean*(UMean &amp; UMean) + internalEMean)</div><div class="line">            );</div><div class="line"></div><div class="line">            Info&lt;&lt; "    Calculating pressure field." &lt;&lt; endl;</div><div class="line">            volScalarField p</div><div class="line">            (</div><div class="line">                IOobject</div><div class="line">                (</div><div class="line">                    "p",</div><div class="line">                    obr_.time().timeName(),</div><div class="line">                    obr_,</div><div class="line">                    IOobject::NO_READ</div><div class="line">                ),</div><div class="line">                physicoChemical::k.value()*rhoNMean*translationalT</div><div class="line">            );</div><div class="line"></div><div class="line">            const fvMesh&amp; mesh = fDMean.mesh();</div><div class="line"></div><div class="line">            forAll(mesh.boundaryMesh(), i)</div><div class="line">            &#123;</div><div class="line">                const polyPatch&amp; patch = mesh.boundaryMesh()[i];</div><div class="line"></div><div class="line">                if (isA&lt;wallPolyPatch&gt;(patch))</div><div class="line">                &#123;</div><div class="line">                    p.boundaryField()[i] =</div><div class="line">                        fDMean.boundaryField()[i]</div><div class="line">                      &amp; (patch.faceAreas()/mag(patch.faceAreas()));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    mag(UMean) max/min : "</div><div class="line">                &lt;&lt; max(mag(UMean)).value() &lt;&lt; " "</div><div class="line">                &lt;&lt; min(mag(UMean)).value() &lt;&lt; endl;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    translationalT max/min : "</div><div class="line">                &lt;&lt; max(translationalT).value() &lt;&lt; " "</div><div class="line">                &lt;&lt; min(translationalT).value() &lt;&lt; endl;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    internalT max/min : "</div><div class="line">                &lt;&lt; max(internalT).value() &lt;&lt; " "</div><div class="line">                &lt;&lt; min(internalT).value() &lt;&lt; endl;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    overallT max/min : "</div><div class="line">                &lt;&lt; max(overallT).value() &lt;&lt; " "</div><div class="line">                &lt;&lt; min(overallT).value() &lt;&lt; endl;</div><div class="line"></div><div class="line">            Info&lt;&lt; "    p max/min : "</div><div class="line">                &lt;&lt; max(p).value() &lt;&lt; " "</div><div class="line">                &lt;&lt; min(p).value() &lt;&lt; endl;</div><div class="line"></div><div class="line">            UMean.write();</div><div class="line"></div><div class="line">            translationalT.write();</div><div class="line"></div><div class="line">            internalT.write();</div><div class="line"></div><div class="line">            overallT.write();</div><div class="line"></div><div class="line">            p.write();</div><div class="line"></div><div class="line">            Info&lt;&lt; "dsmcFields written." &lt;&lt; nl &lt;&lt; endl;</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            Info&lt;&lt; "Small value (" &lt;&lt; min(mag(rhoNMean))</div><div class="line">                &lt;&lt; ") found in rhoNMean field. "</div><div class="line">                &lt;&lt; "Not calculating dsmcFields to avoid division by zero."</div><div class="line">                &lt;&lt; endl;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>明显可以发现<code>dsmcFields</code>所做的只是根据<code>fieldAverage1</code>输出的时均场来求出其他时均场，例如根据时均密度场和时均动量场来求出时均速度场。这个工作也可以由后处理工具<code>dsmcFieldsCalc</code>完成，而不是写成<code>controlDict</code>里面的function object。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>综上分析，有以下总结：</p>
<ul>
<li>用<code>fieldAverage</code>对宏观量场求时均是dsmcFoam里面输出宏观量场的最重要步骤。</li>
<li><code>window</code>控制对那一段时间求平均。如果不设置<code>window</code>就是从开始到当前所有步的平均。<br>如果设置<code>window</code>, 结合<code>base</code>  (<code>ITER</code>/<code>time</code>)，可以设置 从当前时间/步 往前多少s/步 求时均值。</li>
<li><code>dsmcFields</code> 辅助计算其他时均场如 <code>UMean</code>, <code>overallT</code>等等，它只是对<code>fieldAverage</code>输出的时均场做简单的加减乘除计算。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/07/of-dsmcFoam/" data-id="ciu15g4kc0005zcuxpaym94ko" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenFOAM/">OpenFOAM</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/10/06/of-fvMesh/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">OpenFOAM里面的网格对象（fvMesh）</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenFOAM/">OpenFOAM</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/OpenFOAM/" style="font-size: 10px;">OpenFOAM</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/10/07/of-dsmcFoam/">OpenFOAM中的DSMC求解器dsmcFoam分析</a>
          </li>
        
          <li>
            <a href="/2016/10/06/of-fvMesh/">OpenFOAM里面的网格对象（fvMesh）</a>
          </li>
        
          <li>
            <a href="/2016/09/29/of-use-runtime-md/">OpenFOAM 使用Time 控制程序主循环</a>
          </li>
        
          <li>
            <a href="/2016/09/29/of-hello-world/">OpenFOAM 创建程序和使用动态链接库</a>
          </li>
        
          <li>
            <a href="/2016/09/28/OpenFOAM-Learning-Resources/">OpenFOAM 学习资料</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Lianhua Zhu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>